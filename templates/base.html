<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>{{ title or "北寧路早餐店" }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='images/Favicon.png') }}" type="image/x-icon">
</head>
<body data-username="{{ session.get('username', '') }}">
    <header>
        <h1>北寧路早餐店</h1>
        
        <nav>
            <a href="/">首頁</a>
            <a href="/cart">購物車</a>
            <a href="/reviews">評論區</a>  
            {% if not session.get("username") %}
                <a href="/login">登入</a>
                <a href="/register">註冊</a>
            {% endif %}
        </nav>

        <!-- 使用者圖示 + 滑出選單容器 -->
        <div id="user-container">
            <img 
                id="user-icon" 
                src="{% if session.get('avatar') %}/api/profile/avatar/{{ session.get('avatar') }}{% else %}{{ session.get('google_avatar') or url_for('static', filename='images/user.png') }}{% endif %}" 
                alt="使用者圖示"
            >
            
            <div id="user-slide-menu">
                {% if session.get("username") %}
                    <p id="username">使用者：{{ session.get("username") }}</p>
                    <button id="orders-btn">查看訂單</button>
                    <button id="profile-btn">使用者介面</button>
                    <button id="favorites-btn">我的收藏</button>

                    {% if session.get("role") in ["admin", "sub-admin"] %}
                        <hr>
                        <p id="username">管理者專區</p>
                        <button class="admin-btn" data-url="/admin">商品管理</button>
                        <button class="admin-btn" data-url="/admin/stats">商品統計</button>
                        {% if session.get("role") == "admin" %}
                            <button class="admin-btn" data-url="/admin/orders">接單系統</button>
                            <button class="admin-btn" data-url="/admin/user">人員管理</button>
                        {% endif %}
                        <button class="admin-btn" data-url="/admin/promotions">促銷管理</button>
                    {% endif %}

                    <hr>
                    <button id="logout-btn">登出</button>
                {% else %}
                    <p id="user-status">未登入</p>
                    <button id="login-btn">登入</button>
                {% endif %}
            </div>

        </div>

    </header>

    <main>
        {% block content %}{% endblock %}
    </main>

    <footer>
        <p>©北寧路早餐店</p>
    </footer>
<script>
// --- 全域資源初始化 ---
const alertAudio = new Audio("/static/audio/alert.mp3");

document.addEventListener("DOMContentLoaded", () => {
    const currentUser = document.body.dataset.username;
    const userRole = "{{ session.get('role', '') }}"; 
    
    if (!currentUser) return; 

    const globalSource = new EventSource("/events");

    // 輔助函式：顯示紅點 (增加目標參數)
    const showDot = (targetId) => {
        // 1. 先顯示外層頭像的紅點 (讓使用者知道有通知)
        document.getElementById("user-container")?.classList.add("notification-dot");
        
        // 2. 顯示選單內具體按鈕的紅點
        if (targetId) {
            const btn = document.querySelector(`button[data-url="${targetId}"]`) || document.getElementById(targetId);
            btn?.classList.add("notification-dot");
        }
    };

    // --- A. 監聽：訂單狀態更新 (個人下單 -> 點亮「查看訂單」) ---
    globalSource.addEventListener("order_update", function(e) {
        const data = JSON.parse(e.data);
        if (data.username && data.username.trim() === currentUser.trim()) {
            // 顯示頭像紅點 + 「查看訂單」按鈕紅點
            showDot("orders-btn");
            
            if (window.location.pathname === "/orders") {
                alert(`您的訂單 ${data.order_id} 狀態已更新為：${data.status}`);
                location.reload();
            } else {
                alert(`[個人訂單通知] 您的訂單狀態已更新！`);
            }
        }
    });

    // --- B. 監聽：新訂單進來 (管理者接單 -> 點亮「接單系統」) ---
    globalSource.addEventListener("new_order", function(e) {
        if (userRole === "admin" || userRole === "sub-admin") {
            const data = JSON.parse(e.data);

            if (data.username !== currentUser) {
                // 顯示頭像紅點 + 「接單系統」按鈕紅點 (透過 data-url 尋找)
                showDot("/admin/orders"); 
                
                alertAudio.play().catch(() => console.log("等待互動後播放"));

                if (typeof fetchOrders === "function") {
                    fetchOrders();
                } else {
                    alert(`[店務通知] 有新訂單來了！單號：#${data.order_id}`);
                }
            }
        }
    });

    // --- 點擊處理：移除紅點 ---
    // 1. 點擊頭像時，只移除「頭像外層」的紅點，保留選單內的紅點引導使用者點擊
    document.getElementById("user-icon")?.addEventListener("click", () => {
        document.getElementById("user-container")?.classList.remove("notification-dot");
    });

    // 2. 點擊特定按鈕時，移除該按鈕的紅點
    document.querySelectorAll(".notification-dot").forEach(el => {
        el.addEventListener("click", function() {
            this.classList.remove("notification-dot");
        });
    });
});
</script>
    <script defer src="{{ url_for('static', filename='js/user_popup.js') }}"></script>
</body>
</html>