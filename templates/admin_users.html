{% extends "base.html" %}
{% block content %}
<h2>管理後台 - 使用者管理</h2>
<table border="1" cellpadding="5">
    <thead>
        <tr>
            <th>帳號</th>
            <th>角色</th>
            <th>操作</th>
        </tr>
    </thead>
    <tbody id="user-list"></tbody>
</table>

<script>
async function fetchUsers() {
    const res = await fetch("/api/admin/users");
    const users = await res.json();
    const tbody = document.getElementById("user-list");
    tbody.innerHTML = "";
    users.forEach(u => {
        let actions = "";

        if(u.role === "user") {
            actions = `<button onclick="promote('${u.id}')">升級為次管理者</button>`;
        } else if(u.role === "sub-admin") {
            actions = `<button onclick="demote('${u.id}')">降級為一般使用者</button>`;
        }

        // 不可刪除 admin
        actions += u.role === "admin" ? "" : ` <button onclick="deleteUser('${u.id}', '${u.role}')">刪除帳號</button>`;

        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${u.username}</td>
            <td>${u.role}</td>
            <td>${actions}</td>
        `;
        tbody.appendChild(tr);
    });
}

async function promote(userId) {
    const res = await fetch("/api/admin/promote", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id: userId })
    });
    const result = await res.json();
    alert(result.message || "操作成功");
    fetchUsers();
}

async function demote(userId) {
    const res = await fetch("/api/admin/demote", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id: userId })
    });
    const result = await res.json();
    alert(result.message || "操作成功");
    fetchUsers();
}

async function deleteUser(userId, role) {
    if(role === "admin") {
        alert("管理者帳號不可刪除");
        return;
    }
    if(!confirm("確定要刪除這個帳號嗎？")) return;

    const res = await fetch("/api/admin/delete", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id: userId })
    });
    const result = await res.json();
    alert(result.message || "操作成功");
    fetchUsers();
}

// 頁面載入後自動抓使用者
document.addEventListener("DOMContentLoaded", fetchUsers);
</script>
{% endblock %}
