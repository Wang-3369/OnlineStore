{% extends "base.html" %}
{% block content %}

<div class="admin-orders-container">
    <h2>ç®¡ç†å¾Œå° - æ¥å–®ç³»çµ±</h2>
    <div id="orders-container">
        <p class="loading-text">è¼‰å…¥ä¸­</p>
    </div>
</div>

<script>
// --- 1. è³‡æºåˆå§‹åŒ– ---
const alertAudio = new Audio("/static/audio/alert.mp3");
// å–®ä¸€é€£ç·šå¯¦ä¾‹
const eventSource = new EventSource("/events");

// --- 2. è¨‚å–®æ“ä½œåŠŸèƒ½ ---
async function fetchOrders() {
    const res = await fetch("/api/admin/orders");
    const orders = await res.json();
    const container = document.getElementById("orders-container");
    container.innerHTML = "";

    if(orders.length === 0) {
        container.innerHTML = "<p>ç›®å‰æ²’æœ‰è¨‚å–®</p>";
        return;
    }

    orders.forEach(order => {
        let statusClass = `status-${order.status}`;
        let actionButtons = "";
        if (order.status === 'pending') {
            actionButtons = `<button class="btn-accept" onclick="updateStatus('${order.order_id}', 'accepted')">æ¥å—è¨‚å–®</button>
                             <button class="btn-reject" onclick="updateStatus('${order.order_id}', 'rejected')">æ‹’çµ•è¨‚å–®</button>`;
        } else if (order.status === 'accepted') {
            actionButtons = `<button class="btn-complete" onclick="updateStatus('${order.order_id}', 'completed')">é€šçŸ¥é¤é»å®Œæˆ</button>`;
        } else {
            actionButtons = `<span>å·²çµæŸ</span>`;
        }

        let productsHtml = "<ul>";
        for (const pid in order.products) {
            let p = order.products[pid];
            productsHtml += `<li>${p.name} x ${p.quantity} ($${p.price})</li>`;
        }
        productsHtml += "</ul>";

        const div = document.createElement("div");
        div.className = `order-card ${statusClass}`;
        div.innerHTML = `
            <div><h3>å–®è™Ÿï¼š${order.order_id}</h3><span>${order.created_at.split('T')[0]}</span></div>
            <p><strong>é¡§å®¢ï¼š</strong> ${order.username}</p>
            <p><strong>ç‹€æ…‹ï¼š</strong> ${getStatusText(order.status)}</p>
            <p><strong>ç¸½é‡‘é¡ï¼š</strong> NT$ ${order.total}</p>
            <hr>${productsHtml}<div>${actionButtons}</div>`;
        container.appendChild(div);
    });
}

function getStatusText(status) {
    const statusMap = {
        'pending': '<span style="color:orange;">â³ ç­‰å¾…ç¢ºèªä¸­</span>',
        'accepted': '<span style="color:blue;">ğŸ‘¨â€ğŸ³ è£½ä½œä¸­</span>',
        'completed': '<span style="color:green;">âœ… å·²å®Œæˆ</span>',
        'rejected': '<span style="color:red;">âŒ å·²å–æ¶ˆ</span>'
    };
    return statusMap[status] || status;
}

async function updateStatus(orderId, status) {
    if(!confirm(`ç¢ºå®šè¦è®Šæ›´ç‹€æ…‹ç‚º ${status} å—ï¼Ÿ`)) return;
    const res = await fetch("/api/admin/order/status", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ order_id: orderId, status: status })
    });
    if (res.ok) fetchOrders(); 
}

// --- 3. SSE å³æ™‚ç›£è½ ---
eventSource.addEventListener("new_order", function(e) {
    const data = JSON.parse(e.data);
    console.log("ğŸ”” æ”¶åˆ°æ–°è¨‚å–®äº‹ä»¶:", data);

    // æ’­æ”¾éŸ³æ•ˆ
    alertAudio.play().catch(err => console.warn("éŸ³æ•ˆæ’­æ”¾å—é˜»"));

    // æ¡Œé¢é€šçŸ¥
    if (Notification.permission === "granted") {
        const notification = new Notification("ğŸ”” åº—é•·ï¼Œæ–°è¨‚å–®ä¾†äº†ï¼", {
            body: `å–®è™Ÿï¼š#${data.order_id}\né‡‘é¡ï¼šNT$ ${data.total}`,
            icon: "/static/images/Favicon.png", 
            tag: "new-order",      // åŠ ä¸Š tag è®“ç³»çµ±è­˜åˆ¥
            renotify: true,        // å³ä½¿æœ‰èˆŠé€šçŸ¥ä¹Ÿè¦å†æ¬¡æé†’
            requireInteraction: true 
        });

        // é»æ“Šå¾Œè·³è½‰å›è¦–çª—
        notification.onclick = function() {
            window.focus();
            this.close();
        };
    }

    // åˆ·æ–°åˆ—è¡¨
    fetchOrders();
});

// ç›£è½é€£ç·šéŒ¯èª¤
eventSource.onerror = function() {
    console.error("SSE é€£ç·šä¸­æ–·ï¼Œæ­£åœ¨å˜—è©¦é‡æ–°é€£ç·š...");
};

// --- 4. åˆå§‹åŒ– ---
document.addEventListener("DOMContentLoaded", () => {
    fetchOrders();
    
    // è«‹æ±‚é€šçŸ¥æ¬Šé™
    if (Notification.permission !== "granted") {
        Notification.requestPermission();
    }

    // è€é—†é»æ“Šé é¢å¾Œå•Ÿç”¨éŸ³æ•ˆé ç†±
    document.addEventListener('click', () => {
        alertAudio.load();
    }, { once: true });
});
</script>
{% endblock %}