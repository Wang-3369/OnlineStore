{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin_orders.css') }}">

<div class="admin-orders-container">
    <h2>ç®¡ç†å¾Œå° - æ¥å–®ç³»çµ±</h2>
    <div id="orders-container">
        <p class="loading-text">è¼‰å…¥ä¸­</p>
    </div>
</div>

<script>
const evtSource = new EventSource("/events");

evtSource.addEventListener("new_order", function(e) {
    const data = JSON.parse(e.data);
    alert(`ğŸ”” æ–°è¨‚å–®ä¾†äº†ï¼\nç·¨è™Ÿï¼š${data.order_id}\né‡‘é¡ï¼š$${data.total}`);
    location.reload();
});

async function fetchOrders() {
    const res = await fetch("/api/admin/orders");
    const orders = await res.json();
    const container = document.getElementById("orders-container");
    container.innerHTML = "";

    if(orders.length === 0) {
        container.innerHTML = "<p>ç›®å‰æ²’æœ‰è¨‚å–®</p>";
        return;
    }

    orders.forEach(order => {
        let statusClass = `status-${order.status}`;
        let actionButtons = "";

        // æ ¹æ“šç‹€æ…‹é¡¯ç¤ºå°æ‡‰æŒ‰éˆ•
        if (order.status === 'pending') {
            actionButtons = `
                <button class="btn-accept" onclick="updateStatus('${order.order_id}', 'accepted')">æ¥å—è¨‚å–®</button>
                <button class="btn-reject" onclick="updateStatus('${order.order_id}', 'rejected')">æ‹’çµ•è¨‚å–®</button>
            `;
        } else if (order.status === 'accepted') {
            actionButtons = `
                <button class="btn-complete" onclick="updateStatus('${order.order_id}', 'completed')">é€šçŸ¥é¤é»å®Œæˆ</button>
            `;
        } else {
            actionButtons = `<span>å·²çµæŸ</span>`;
        }

        // çµ„åˆå•†å“åˆ—è¡¨ HTML
        let productsHtml = "<ul>";
        for (const pid in order.products) {
            let p = order.products[pid];
            productsHtml += `<li>${p.name} x ${p.quantity} ($${p.price})</li>`;
        }
        productsHtml += "</ul>";

        const div = document.createElement("div");
        div.className = `order-card ${statusClass}`;
        div.innerHTML = `
            <div>
                <h3>å–®è™Ÿï¼š${order.order_id}</h3>
                <span>${order.created_at.split('T')[0]}</span>
            </div>
            <p><strong>é¡§å®¢ï¼š</strong> ${order.username}</p>
            <p><strong>å–é¤æ™‚é–“ï¼š</strong> ${order.pickup_time || 'æœªæŒ‡å®š'}</p>
            <p><strong>å‚™è¨»ï¼š</strong> ${order.note || 'ï¼ˆç„¡å‚™è¨»ï¼‰'}</p>
            <p><strong>ç‹€æ…‹ï¼š</strong> ${getStatusText(order.status)}</p>
            <p><strong>ç¸½é‡‘é¡ï¼š</strong> NT$ ${order.total}</p>
            <hr>
            ${productsHtml}
            <div>
                ${actionButtons}
            </div>
        `;
        container.appendChild(div);
    });
}

function getStatusText(status) {
    const statusMap = {
        'pending': '<span style="color:orange;">â³ ç­‰å¾…ç¢ºèªä¸­</span>',
        'accepted': '<span style="color:blue;">ğŸ‘¨â€ğŸ³ è£½ä½œä¸­</span>',
        'completed': '<span style="color:green;">âœ… å·²å®Œæˆ</span>',
        'rejected': '<span style="color:red;">âŒ å·²å–æ¶ˆ</span>'
    };
    return statusMap[status] || status;
}

async function updateStatus(orderId, status) {
    if(!confirm(`ç¢ºå®šè¦å°‡ç‹€æ…‹æ”¹ç‚º ${status} å—ï¼Ÿ`)) return;
    
    const res = await fetch("/api/admin/order/status", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ order_id: orderId, status: status })
    });
    const result = await res.json();
    if (res.ok) {
        location.reload();
    } else {
        const result = await res.json();
        alert("æ›´æ–°å¤±æ•—ï¼š" + result.message);
    }
}

// é é¢è¼‰å…¥å¾ŒåŸ·è¡Œ
document.addEventListener("DOMContentLoaded", () => {
    fetchOrders();
    setInterval(fetchOrders, 10000); // æ¯10ç§’è‡ªå‹•æ›´æ–°
});
</script>
{% endblock %}