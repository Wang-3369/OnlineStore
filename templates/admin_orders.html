{% extends "base.html" %}
{% block content %}
<style>
    .order-card { border: 1px solid #ccc; padding: 15px; margin-bottom: 15px; border-radius: 8px; background: #fff; }
    .status-pending { border-left: 5px solid orange; }
    .status-accepted { border-left: 5px solid blue; }
    .status-completed { border-left: 5px solid green; }
    .status-rejected { border-left: 5px solid red; opacity: 0.6; }
    .btn-accept { background-color: #28a745; color: white; padding: 5px 10px; border:none; cursor:pointer;}
    .btn-reject { background-color: #dc3545; color: white; padding: 5px 10px; border:none; cursor:pointer;}
    .btn-complete { background-color: #007bff; color: white; padding: 5px 10px; border:none; cursor:pointer;}
</style>

<h2>老闆管理後台 - 接單系統</h2>
<div id="orders-container">載入中...</div>

<script>
async function fetchOrders() {
    const res = await fetch("/api/admin/orders");
    const orders = await res.json();
    const container = document.getElementById("orders-container");
    container.innerHTML = "";

    if(orders.length === 0) {
        container.innerHTML = "<p>目前沒有訂單</p>";
        return;
    }

    orders.forEach(order => {
        let statusClass = `status-${order.status}`;
        let actionButtons = "";

        // 根據狀態顯示對應按鈕
        if (order.status === 'pending') {
            actionButtons = `
                <button class="btn-accept" onclick="updateStatus('${order.order_id}', 'accepted')">接受訂單</button>
                <button class="btn-reject" onclick="updateStatus('${order.order_id}', 'rejected')">拒絕訂單</button>
            `;
        } else if (order.status === 'accepted') {
            actionButtons = `
                <button class="btn-complete" onclick="updateStatus('${order.order_id}', 'completed')">通知餐點完成</button>
            `;
        } else {
            actionButtons = `<span>已結束</span>`;
        }

        // 組合商品列表 HTML
        let productsHtml = "<ul>";
        for (const pid in order.products) {
            let p = order.products[pid];
            productsHtml += `<li>${p.name} x ${p.quantity} ($${p.price})</li>`;
        }
        productsHtml += "</ul>";

        const div = document.createElement("div");
        div.className = `order-card ${statusClass}`;
        div.innerHTML = `
            <div style="display:flex; justify-content:space-between;">
                <h3>單號：${order.order_id}</h3>
                <span>${order.created_at.split('T')[0]}</span>
            </div>
            <p><strong>顧客：</strong> ${order.username}</p>
            <p><strong>取餐時間：</strong> ${order.pickup_time || '未指定'}</p>
            <p><strong>備註：</strong> ${order.note || '（無備註）'}</p>
            <p><strong>狀態：</strong> ${order.status}</p>
            <p><strong>總金額：</strong> $${order.total}</p>
            <hr>
            ${productsHtml}
            <div style="margin-top:10px; text-align:right;">
                ${actionButtons}
            </div>
        `;
        container.appendChild(div);
    });
}

async function updateStatus(orderId, status) {
    if(!confirm(`確定要將狀態改為 ${status} 嗎？`)) return;
    
    const res = await fetch("/api/admin/order/status", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ order_id: orderId, status: status })
    });
    const result = await res.json();
    alert(result.message);
    fetchOrders(); // 更新畫面
}

// 頁面載入後執行
document.addEventListener("DOMContentLoaded", () => {
    fetchOrders();
    setInterval(fetchOrders, 10000); 
});
</script>
{% endblock %}